<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Job Tracker Dashboard</title>
    <script src="https://d3js.org/d3.v7.min.js"></script>
    <script src="https://unpkg.com/d3-sankey@0.12.3/dist/d3-sankey.min.js"></script>
    <style>
        :root {
            --primary-color: #667eea; --secondary-color: #764ba2;
            --dark-blue: #2c3e50; --light-gray: #f8f9fa;
            --text-dark: #333; --text-light: #7f8c8d;
        }
        * { margin: 0; padding: 0; box-sizing: border-box; }
        body { font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif; background: linear-gradient(135deg, var(--primary-color) 0%, var(--secondary-color) 100%); min-height: 100vh; padding: 20px; }
        .container { max-width: 1400px; margin: 0 auto; background: white; border-radius: 15px; box-shadow: 0 20px 40px rgba(0,0,0,0.1); overflow: hidden; }
        .header { background: linear-gradient(135deg, #2c3e50 0%, #34495e 100%); color: white; padding: 30px; display: flex; justify-content: space-between; align-items: center; flex-wrap: wrap; gap: 20px;}
        .header h1 { font-size: 2.2em; }
        .dashboard { padding: 30px; }
        .stats-section { background: var(--light-gray); padding: 25px; border-radius: 10px; margin-bottom: 30px; }
        .stats-grid { display: grid; grid-template-columns: repeat(auto-fit, minmax(150px, 1fr)); gap: 20px; margin-bottom: 30px; }
        .stat-card { background: white; padding: 20px; border-radius: 8px; text-align: center; box-shadow: 0 2px 10px rgba(0,0,0,0.05); transition: transform 0.2s; }
        .stat-card:hover { transform: translateY(-3px); }
        .stat-number { font-size: 2em; font-weight: bold; color: var(--dark-blue); }
        .stat-label { color: var(--text-light); margin-top: 5px; }
        .sankey-container { background: white; border-radius: 10px; padding: 20px; box-shadow: 0 2px 15px rgba(0,0,0,0.05); }
        .sankey-title, .jobs-title { font-size: 1.5em; margin-bottom: 20px; color: var(--dark-blue); text-align: center; }
        #jobsList { display: grid; grid-template-columns: repeat(auto-fit, minmax(350px, 1fr)); gap: 20px; }
        .job-card { background: var(--light-gray); border-radius: 8px; padding: 20px; border-left: 5px solid; transition: all 0.2s; display: flex; flex-direction: column; justify-content: space-between; }
        .job-card:hover { box-shadow: 0 6px 20px rgba(0,0,0,0.1); transform: translateY(-5px); }
        .job-header { display: flex; justify-content: space-between; align-items: flex-start; margin-bottom: 15px; }
        .job-title { font-size: 1.2em; font-weight: bold; color: var(--dark-blue); margin-bottom: 5px; }
        .job-company { color: var(--text-light); font-size: 1em; }
        .job-status { padding: 5px 12px; border-radius: 20px; font-size: 0.8em; font-weight: bold; text-transform: uppercase; white-space: nowrap; }
        .job-card-actions { margin-top: 15px; display: flex; gap: 10px; flex-wrap: wrap; border-top: 1px solid #e0e0e0; padding-top: 15px; }
        .status-buttons { margin-top: 15px; }
        .status-buttons p { font-size: 0.9em; font-weight: bold; color: #555; margin-bottom: 10px; }
        .status-btn { background: #fff; color: #555; border: 1px solid #ddd; padding: 6px 12px; border-radius: 20px; cursor: pointer; transition: all 0.2s; font-size: 0.8em; }
        .status-btn:hover { background: var(--primary-color); color: white; border-color: var(--primary-color); transform: scale(1.05); }
        .action-btn { background: #3498db; color: white; border: none; padding: 8px 16px; border-radius: 5px; cursor: pointer; transition: background 0.2s; }
        .action-btn:hover { opacity: 0.8; }
        .edit-btn { background: #f39c12; }
        .details-btn { background: #95a5a6; }
        .add-job-btn { background: #2ecc71; color: white; border: none; padding: 12px 24px; border-radius: 25px; cursor: pointer; font-size: 1em; transition: background 0.2s; text-decoration: none;}
        .add-job-btn:hover { background: #27ae60; }
        .refresh-btn { position: fixed; bottom: 30px; right: 30px; background: #e74c3c; color: white; border: none; padding: 15px 20px; border-radius: 50px; cursor: pointer; font-size: 1em; box-shadow: 0 4px 15px rgba(0,0,0,0.2); transition: all 0.2s; }
        .status-applied { border-color: #1976d2; } .status-applied .job-status { background: #e3f2fd; color: #1976d2; }
        .status-interview-scheduled { border-color: #f57c00; } .status-interview-scheduled .job-status { background: #fff3e0; color: #f57c00; }
        .status-interviewed { border-color: #7b1fa2; } .status-interviewed .job-status { background: #f3e5f5; color: #7b1fa2; }
        .status-hired { border-color: #388e3c; } .status-hired .job-status { background: #e8f5e9; color: #388e3c; }
        .status-rejected { border-color: #d32f2f; } .status-rejected .job-status { background: #ffebee; color: #d32f2f; }
        .status-ghosted { border-color: #616161; } .status-ghosted .job-status { background: #f5f5f5; color: #616161; }
        .status-withdrawn { border-color: #c2185b; } .status-withdrawn .job-status { background: #fce4ec; color: #c2185b; }
        .modal { display: none; position: fixed; z-index: 1000; left: 0; top: 0; width: 100%; height: 100%; overflow: auto; background-color: rgba(0,0,0,0.5); backdrop-filter: blur(5px); }
        .modal-content { background-color: #fefefe; margin: 10% auto; padding: 30px; border: 1px solid #888; width: 80%; max-width: 700px; border-radius: 10px; box-shadow: 0 5px 20px rgba(0,0,0,0.3); }
        .modal-header { display: flex; justify-content: space-between; align-items: center; border-bottom: 1px solid #eee; padding-bottom: 15px; margin-bottom: 20px;}
        .close-btn { color: #aaa; font-size: 28px; font-weight: bold; cursor: pointer; }
        .modal-body .form-group { margin-bottom: 15px; }
        .modal-body label { display: block; margin-bottom: 5px; font-weight: bold; color: #555; }
        .modal-body input, .modal-body textarea { width: 100%; padding: 10px; border: 1px solid #ddd; border-radius: 5px; font-size: 1em; }
    </style>
</head>
<body>
    <div class="container">
        <div class="header">
            <div><h1>ðŸŽ¯ Job Tracker Dashboard</h1><p>Visually track your career path</p></div>
            <a href="/add" class="add-job-btn">âž• Add New Job</a>
        </div>
        <div class="dashboard">
             <div class="stats-section">
                <div class="stats-grid" id="statsGrid"></div>
                <div class="sankey-container">
                    <div class="sankey-title">Application Journey</div>
                    <div id="sankeyChart"></div>
                </div>
            </div>
            <div class="jobs-section">
                <div class="jobs-title">Current Applications</div>
                <div id="jobsList"></div>
            </div>
        </div>
    </div>
    <div id="detailsModal" class="modal"><div class="modal-content"><div class="modal-header"><h2 id="detailsModalTitle"></h2><span class="close-btn" onclick="closeModal('detailsModal')">&times;</span></div><div class="modal-body" id="detailsModalBody"></div></div></div>
    <div id="editModal" class="modal"><div class="modal-content"><div class="modal-header"><h2>Edit Job</h2><span class="close-btn" onclick="closeModal('editModal')">&times;</span></div><div class="modal-body"><input type="hidden" id="editJobId"><div class="form-group"><label for="editTitle">Title</label><input type="text" id="editTitle"></div><div class="form-group"><label for="editCompany">Company</label><input type="text" id="editCompany"></div><div class="form-group"><label for="editLocation">Location</label><input type="text" id="editLocation"></div><div class="form-group"><label for="editSalary">Salary</label><input type="text" id="editSalary"></div><div class="form-group"><label for="editUrl">URL</label><input type="text" id="editUrl"></div><div class="form-group"><label for="editDescription">Description</label><textarea id="editDescription"></textarea></div><button class="action-btn" onclick="saveJobChanges()">Save</button></div></div></div>
    <button class="refresh-btn" onclick="loadData()">ðŸ”„ Refresh</button>
    <script>
        document.addEventListener('DOMContentLoaded', loadData);

        function renderSankeyChart() {
            const sankeyData = statsData.sankey_data;
            const sankeyContainer = document.getElementById('sankeyChart');
            sankeyContainer.innerHTML = ''; 

            if (!sankeyData || !sankeyData.nodes.length || !sankeyData.links.length) {
                sankeyContainer.innerHTML = '<p style="text-align: center; color: #7f8c8d;">Not enough data for the journey chart.</p>';
                return;
            }

            const margin = {top: 20, right: 150, bottom: 20, left: 150};
            const width = sankeyContainer.clientWidth > 0 ? sankeyContainer.clientWidth - margin.left - margin.right : 600;
            const height = 400 - margin.top - margin.bottom;

            const svg = d3.select(sankeyContainer).append("svg")
                .attr("width", width + margin.left + margin.right)
                .attr("height", height + margin.top + margin.bottom)
              .append("g")
                .attr("transform", `translate(${margin.left},${margin.top})`);

            const sankey = d3.sankey()
                .nodeId(d => d.name)
                .nodeAlign(d3.sankeyJustify)
                .nodeWidth(15)
                .nodePadding(20)
                .extent([[1, 5], [width - 1, height - 5]]);

            const graph = sankey(sankeyData);

            const color = d3.scaleOrdinal()
                .domain(["Applied", "Interview Scheduled", "Interviewed", "Hired", "Rejected", "Ghosted", "Withdrawn"])
                .range(["#1976d2", "#f57c00", "#7b1fa2", "#388e3c", "#d32f2f", "#616161", "#c2185b"]);
            
            const defs = svg.append('defs');
            graph.links.forEach((link, i) => {
                const gradient = defs.append("linearGradient")
                    .attr("id", `gradient-${i}`)
                    .attr("gradientUnits", "userSpaceOnUse")
                    .attr("x1", link.source.x1)
                    .attr("x2", link.target.x0);
                gradient.append("stop").attr("offset", "0%").attr("stop-color", color(link.source.name));
                gradient.append("stop").attr("offset", "100%").attr("stop-color", color(link.target.name));
            });

            svg.append("g").attr("fill", "none")
              .selectAll("g").data(graph.links).join("path")
                .attr("d", d3.sankeyLinkHorizontal())
                .attr("stroke", (d, i) => `url(#gradient-${i})`)
                .attr("stroke-width", d => Math.max(1, d.width))
                .attr("stroke-opacity", 0.6)
                .on("mouseover", function() { d3.select(this).attr("stroke-opacity", 0.9); })
                .on("mouseout", function() { d3.select(this).attr("stroke-opacity", 0.6); })
              .append("title")
                .text(d => `${d.source.name} â†’ ${d.target.name}\n${d.value}`);

            const node = svg.append("g").selectAll("g").data(graph.nodes).join("g");
            node.append("rect")
                .attr("x", d => d.x0).attr("y", d => d.y0)
                .attr("height", d => d.y1 - d.y0).attr("width", d => d.x1 - d.x0)
                .attr("fill", d => color(d.name)).attr("stroke", "#000").attr("stroke-width", 0.5)
              .append("title")
                .text(d => `${d.name}\n${d.value}`);

            node.append("text")
                .attr("x", d => d.x0 < width / 2 ? d.x1 + 6 : d.x0 - 6)
                .attr("y", d => (d.y1 + d.y0) / 2).attr("dy", "0.35em")
                .attr("text-anchor", d => d.x0 < width / 2 ? "start" : "end")
                .style("font-size", "14px").style("font-weight", "bold").style("fill", "#333")
                .text(d => `${d.name} (${d.value})`);
        }
        
        // --- Paste in the other Javascript functions from the previous response below ---
        let jobsData = []; let statsData = {};
        async function loadData() { try { const [jobsResponse, statsResponse] = await Promise.all([ fetch('/api/jobs'), fetch('/api/stats') ]); jobsData = await jobsResponse.json(); statsData = await statsResponse.json(); renderStats(); renderSankeyChart(); renderJobs(); } catch (error) { console.error('Error loading data:', error); } }
        function renderStats() { const statsGrid = document.getElementById('statsGrid'); const stats = statsData.status_counts || {}; const interviewCount = (stats['Interview Scheduled'] || 0) + (stats['Interviewed'] || 0); const statCards = [ { label: 'Total Jobs', value: statsData.total_jobs || 0, color: '#3498db' }, { label: 'Applied', value: stats.Applied || 0, color: '#1976d2' }, { label: 'Interviews', value: interviewCount, color: '#f57c00' }, { label: 'Hired', value: stats.Hired || 0, color: '#388e3c' }, { label: 'Rejected', value: stats.Rejected || 0, color: '#d32f2f' }, { label: 'Ghosted', value: stats.Ghosted || 0, color: '#616161' } ]; statsGrid.innerHTML = statCards.map(stat => `<div class="stat-card"><div class="stat-number" style="color: ${stat.color}">${stat.value}</div><div class="stat-label">${stat.label}</div></div>`).join(''); }
        function getNextStatusOptions(currentStatus) { const flow = { "Applied": ["Interview Scheduled", "Rejected", "Withdrawn"], "Interview Scheduled": ["Interviewed", "Rejected", "Withdrawn"], "Interviewed": ["Hired", "Rejected", "Ghosted", "Withdrawn"], }; return flow[currentStatus] || []; }
        function renderJobs() { const jobsList = document.getElementById('jobsList'); if (!jobsData || !jobsData.length) { jobsList.innerHTML = '<p style="text-align: center; color: #7f8c8d;">No jobs found. Add one to get started!</p>'; return; } jobsList.innerHTML = jobsData.map((job, index) => { const statusClass = job.status.toLowerCase().replace(/\s+/g, '-'); const nextStatuses = getNextStatusOptions(job.status); const statusButtonsHtml = nextStatuses.length > 0 ? `<div class="status-buttons"><p>Next Step:</p>${nextStatuses.map(s => `<button class="status-btn" onclick="updateJobStatus(${index}, '${s}')">${s}</button>`).join('')}</div>` : ''; return ` <div class="job-card status-${statusClass}"> <div> <div class="job-header"> <div> <div class="job-title">${job.title}</div> <div class="job-company">${job.company}</div> </div> <div class="job-status">${job.status}</div> </div> <div class="job-details"> <strong>Updated:</strong> ${job.last_update} </div> ${statusButtonsHtml} </div> <div class="job-card-actions"> <button class="action-btn details-btn" onclick="showDetails(${index})">Details</button> <button class="action-btn edit-btn" onclick="showEditModal(${index})">Edit</button> </div> </div>`; }).join(''); }
        async function updateJobStatus(jobIndex, newStatus) { try { const response = await fetch('/api/update_status', { method: 'POST', headers: {'Content-Type': 'application/json'}, body: JSON.stringify({ job_id: jobIndex, status: newStatus }) }); if (response.ok) loadData(); else alert('Failed to update status'); } catch (error) { console.error('Error updating status:', error); } }
        function closeModal(modalId) { document.getElementById(modalId).style.display = 'none'; }
        async function showDetails(jobIndex) { const job = jobsData[jobIndex]; const modalBody = document.getElementById('detailsModalBody'); let otherInfoHtml = ''; if (job.other_info) { for (const [key, value] of Object.entries(job.other_info)) { if (value) otherInfoHtml += `<p><strong>${key.charAt(0).toUpperCase() + key.slice(1)}:</strong> ${Array.isArray(value) ? value.join(', ') : value}</p>`; } } modalBody.innerHTML = `<p><strong>Company:</strong> ${job.company}</p><p><strong>Date Added:</strong> ${job.date_added}</p><p><strong>Last Updated:</strong> ${job.last_update}</p>${otherInfoHtml}<hr style="margin: 15px 0;"><p><strong>Description:</strong></p><p>${job.description || 'N/A'}</p><hr style="margin: 15px 0;"><p><strong>URL:</strong> <a href="${job.url || job.source}" target="_blank">View Posting</a></p>`; document.getElementById('detailsModalTitle').innerText = job.title; document.getElementById('detailsModal').style.display = 'block'; }
        function showEditModal(jobIndex) { const job = jobsData[jobIndex]; document.getElementById('editJobId').value = jobIndex; document.getElementById('editTitle').value = job.title; document.getElementById('editCompany').value = job.company; document.getElementById('editDescription').value = job.description; document.getElementById('editLocation').value = Array.isArray(job.other_info?.location) ? job.other_info.location.join(', ') : job.other_info?.location || ''; document.getElementById('editSalary').value = job.other_info?.salary || ''; document.getElementById('editUrl').value = job.url || job.source || ''; document.getElementById('editModal').style.display = 'block'; }
        async function saveJobChanges() { const jobIndex = document.getElementById('editJobId').value; const updatedJob = { title: document.getElementById('editTitle').value, company: document.getElementById('editCompany').value, description: document.getElementById('editDescription').value, location: document.getElementById('editLocation').value, salary: document.getElementById('editSalary').value, url: document.getElementById('editUrl').value, }; try { const response = await fetch(`/api/job/${jobIndex}`, { method: 'POST', headers: {'Content-Type': 'application/json'}, body: JSON.stringify(updatedJob) }); if (response.ok) { closeModal('editModal'); loadData(); } else { alert('Failed to save changes.'); } } catch (error) { console.error('Error saving job changes:', error); } }
    </script>
</body>
</html>

